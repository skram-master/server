name: detekt

on:
  # Comment out push for resource saving
  # push:
  pull_request:
    branches:
      - main
      - develop
      - 'feature/*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detekt:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Cache SDKMAN
        uses: actions/cache@v4
        with:
          path: ~/.sdkman
          key: sdkman-java-22-amzn
          restore-keys: |
            sdkman-java-

      - name: Install SDKMAN and Corretto 22
        if: steps.cache.outputs.cache-hit != 'true'
        run: |
          curl -s "https://get.sdkman.io" | bash
          source "$HOME/.sdkman/bin/sdkman-init.sh"
          sdk install java 22.0.2-amzn

      - name: Set JAVA_HOME for Corretto 22
        run: |
          echo "JAVA_HOME=$HOME/.sdkman/candidates/java/current" >> $GITHUB_ENV
          echo "$HOME/.sdkman/candidates/java/current/bin" >> $GITHUB_PATH

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: detekt
        run: ./gradlew detekt -Pdetekt.autoCorrect=true

      - name: Parse detekt report error
        if: failure()
        run: python .github/workflows/parse_detekt.py
        env:
          GITHUB_URL: ${{ github.server_url }}
          REPOSITORY_URL: ${{ github.repository }}
          BRANCH: ${{ github.head_ref }}
          DETEKT_REPORT_PATH: build/reports/detekt/merge.xml
